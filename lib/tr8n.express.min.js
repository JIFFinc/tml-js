/*! tr8n 18-07-2014 */
var MD5=function(a){function b(a,b){return a<<b|a>>>32-b}function c(a,b){var c,d,e,f,g;return e=2147483648&a,f=2147483648&b,c=1073741824&a,d=1073741824&b,g=(1073741823&a)+(1073741823&b),c&d?2147483648^g^e^f:c|d?1073741824&g?3221225472^g^e^f:1073741824^g^e^f:g^e^f}function d(a,b,c){return a&b|~a&c}function e(a,b,c){return a&c|b&~c}function f(a,b,c){return a^b^c}function g(a,b,c){return b^(a|~c)}function h(a,e,f,g,h,i,j){return a=c(a,c(c(d(e,f,g),h),j)),c(b(a,i),e)}function i(a,d,f,g,h,i,j){return a=c(a,c(c(e(d,f,g),h),j)),c(b(a,i),d)}function j(a,d,e,g,h,i,j){return a=c(a,c(c(f(d,e,g),h),j)),c(b(a,i),d)}function k(a,d,e,f,h,i,j){return a=c(a,c(c(g(d,e,f),h),j)),c(b(a,i),d)}function l(a){for(var b,c=a.length,d=c+8,e=(d-d%64)/64,f=16*(e+1),g=Array(f-1),h=0,i=0;c>i;)b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|a.charCodeAt(i)<<h,i++;return b=(i-i%4)/4,h=i%4*8,g[b]=g[b]|128<<h,g[f-2]=c<<3,g[f-1]=c>>>29,g}function m(a){var b,c,d="",e="";for(c=0;3>=c;c++)b=a>>>8*c&255,e="0"+b.toString(16),d+=e.substr(e.length-2,2);return d}function n(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):d>127&&2048>d?(b+=String.fromCharCode(d>>6|192),b+=String.fromCharCode(63&d|128)):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128),b+=String.fromCharCode(63&d|128))}return b}var o,p,q,r,s,t,u,v,w,x=Array(),y=7,z=12,A=17,B=22,C=5,D=9,E=14,F=20,G=4,H=11,I=16,J=23,K=6,L=10,M=15,N=21;for(a=n(a),x=l(a),t=1732584193,u=4023233417,v=2562383102,w=271733878,o=0;o<x.length;o+=16)p=t,q=u,r=v,s=w,t=h(t,u,v,w,x[o+0],y,3614090360),w=h(w,t,u,v,x[o+1],z,3905402710),v=h(v,w,t,u,x[o+2],A,606105819),u=h(u,v,w,t,x[o+3],B,3250441966),t=h(t,u,v,w,x[o+4],y,4118548399),w=h(w,t,u,v,x[o+5],z,1200080426),v=h(v,w,t,u,x[o+6],A,2821735955),u=h(u,v,w,t,x[o+7],B,4249261313),t=h(t,u,v,w,x[o+8],y,1770035416),w=h(w,t,u,v,x[o+9],z,2336552879),v=h(v,w,t,u,x[o+10],A,4294925233),u=h(u,v,w,t,x[o+11],B,2304563134),t=h(t,u,v,w,x[o+12],y,1804603682),w=h(w,t,u,v,x[o+13],z,4254626195),v=h(v,w,t,u,x[o+14],A,2792965006),u=h(u,v,w,t,x[o+15],B,1236535329),t=i(t,u,v,w,x[o+1],C,4129170786),w=i(w,t,u,v,x[o+6],D,3225465664),v=i(v,w,t,u,x[o+11],E,643717713),u=i(u,v,w,t,x[o+0],F,3921069994),t=i(t,u,v,w,x[o+5],C,3593408605),w=i(w,t,u,v,x[o+10],D,38016083),v=i(v,w,t,u,x[o+15],E,3634488961),u=i(u,v,w,t,x[o+4],F,3889429448),t=i(t,u,v,w,x[o+9],C,568446438),w=i(w,t,u,v,x[o+14],D,3275163606),v=i(v,w,t,u,x[o+3],E,4107603335),u=i(u,v,w,t,x[o+8],F,1163531501),t=i(t,u,v,w,x[o+13],C,2850285829),w=i(w,t,u,v,x[o+2],D,4243563512),v=i(v,w,t,u,x[o+7],E,1735328473),u=i(u,v,w,t,x[o+12],F,2368359562),t=j(t,u,v,w,x[o+5],G,4294588738),w=j(w,t,u,v,x[o+8],H,2272392833),v=j(v,w,t,u,x[o+11],I,1839030562),u=j(u,v,w,t,x[o+14],J,4259657740),t=j(t,u,v,w,x[o+1],G,2763975236),w=j(w,t,u,v,x[o+4],H,1272893353),v=j(v,w,t,u,x[o+7],I,4139469664),u=j(u,v,w,t,x[o+10],J,3200236656),t=j(t,u,v,w,x[o+13],G,681279174),w=j(w,t,u,v,x[o+0],H,3936430074),v=j(v,w,t,u,x[o+3],I,3572445317),u=j(u,v,w,t,x[o+6],J,76029189),t=j(t,u,v,w,x[o+9],G,3654602809),w=j(w,t,u,v,x[o+12],H,3873151461),v=j(v,w,t,u,x[o+15],I,530742520),u=j(u,v,w,t,x[o+2],J,3299628645),t=k(t,u,v,w,x[o+0],K,4096336452),w=k(w,t,u,v,x[o+7],L,1126891415),v=k(v,w,t,u,x[o+14],M,2878612391),u=k(u,v,w,t,x[o+5],N,4237533241),t=k(t,u,v,w,x[o+12],K,1700485571),w=k(w,t,u,v,x[o+3],L,2399980690),v=k(v,w,t,u,x[o+10],M,4293915773),u=k(u,v,w,t,x[o+1],N,2240044497),t=k(t,u,v,w,x[o+8],K,1873313359),w=k(w,t,u,v,x[o+15],L,4264355552),v=k(v,w,t,u,x[o+6],M,2734768916),u=k(u,v,w,t,x[o+13],N,1309151649),t=k(t,u,v,w,x[o+4],K,4149444226),w=k(w,t,u,v,x[o+11],L,3174756917),v=k(v,w,t,u,x[o+2],M,718787259),u=k(u,v,w,t,x[o+9],N,3951481745),t=c(t,p),u=c(u,q),v=c(v,r),w=c(w,s);var O=m(t)+m(u)+m(v)+m(w);return O.toLowerCase()},Tr8n={Tokenizers:{},Tokens:{},RulesEngine:{},Decorators:{},Utils:{},Api:{},Cache:{}};Tr8n.Api.Ajax=function(){},Tr8n.Api.Jsonp=function(){},Tr8n.Api.Request=function(){},Tr8n.Cache.Base=function(){},Tr8n.Cache.Base.prototype={version_key:"__tr8n_version__",key_prefix:"tr8n_v",read_only:!0,cached_by_source:!0,name:"",fetch:function(){},store:function(){},"delete":function(){},exists:function(){},warn:function(a){console.warn("%s - %s",this.name,a)},info:function(a){console.info("%s - %s",this.name,a)},version:function(){return this.version||(this.version=1),this.version},versionedKey:function(a){return this.key_prefix+this.version+"_"+a}},Tr8n.Cache.Browser=function(){},Tr8n.Cache.Dom=function(){};var fs=require("fs"),config=Tr8n.config,extend=Tr8n.Utils.extend;Tr8n.Cache.Files=function(){},Tr8n.Cache.Files.prototype=extend(new Tr8n.Cache.Base,{name:"file",fetch:function(a,b,c){var d,e=this.filePath(a);fs.readFile(e,"utf8",function(e,f){e?(this.info("Cache miss "+a),d="function"==typeof b?b():b||null):(this.info("Cache hit "+a),d=JSON.parse(f)),c&&c(d)}.bind(this))},cachePath:function(){return"./../../cache/files/current"},filePath:function(a){return this.cachePath()+"/"+this.fileName(a)},fileName:function(a){return a.replace(/[\.\/]/g,"-")+".json"},store:function(){this.warn("This is a readonly cache")},"delete":function(){return this.warn("This is a readonly cache"),null}});var memcache=require("memcache"),extend=Tr8n.Utils.extend;Tr8n.Cache.Memcache=function(){this.cache=new memcache.Client},Tr8n.Cache.Memcache.prototype=extend(new Tr8n.Cache.Base,{name:"memcache",read_only:!1,fetch:function(a,b,c){this.cache.get(a,function(d,e){d||!e?(this.info("Cache miss "+a),value="function"==typeof b?b():b||null):(this.info("Cache hit "+a),value=JSON.parse(e)),c&&c(value)}.bind(this))},store:function(a,b,c){return this.info("Cache store "+a),this.cache.set(this.versionedKey(a),JSON.stringify(b),c)},"delete":function(a,b){this.cache.delete(a,b)},exists:function(a,b){this.cache.get(a,function(a,c){b&&b(!(a||!c))})}});var redis=require("redis"),extend=Tr8n.Utils.extend;Tr8n.Cache.Redis=function(){this.cache=redis.createClient({})},Tr8n.Cache.Redis.prototype=extend(new Tr8n.Cache.Base,{name:"redis",read_only:!1,fetch:function(a,b,c){this.cache.get(a,function(d,e){d||!e?(this.info("Cache miss "+a),value="function"==typeof b?b():b||null):(this.info("Cache hit "+a),value=this.deserialize(a,e)),c&&c(value)}.bind(this))},store:function(a,b,c){return this.info("Cache store "+a),this.cache.set(this.versionedKey(a),this.serialize(a,b),c)},"delete":function(a,b){this.cache.del(a,b)},exists:function(a,b){this.cache.get(a,function(a,c){b&&b(!(a||!c))})}});var crypto=require("crypto");Tr8n.Utils={hashValue:function(a,b,c){c=c||null;for(var d=b.split("."),e=0;e<d.length;e++){var f=d[e];if("undefined"==typeof a[f])return c;a=a[f]}return a},stripTags:function(a,b){b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var c=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,d=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return a.replace(d,"").replace(c,function(a,c){return b.indexOf("<"+c.toLowerCase()+">")>-1?a:""})},splitSentences:function(a){var b=/[^.!?\s][^.!?]*(?:[.!?](?![\'"]?\s|$)[^.!?]*)*[.!?]?[\'"]?(?=\s|$)/g;return Tr8n.Utils.stripTags(a).match(b)},unique:function(a){return a.reverse().filter(function(a,b,c){return-1===c.indexOf(a,b+1)}).reverse()},extend:function(a,b){for(var c in b)a[c]=b[c];return a},clone:function(a){if(null==a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)b[c]=clone(a[c]);return b},keys:function(a){return Object.keys(a)},generateKey:function(a,b){return MD5(a+";;;"+b)},isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)},isObject:function(a){return"object"==typeof a},isFunction:function(a){return"function"==typeof a},escapeHTML:function(a){return a.replace(/[&<>]/g,function(a){return{"&":"&amp;","<":"&lt;",">":"&gt;"}[a]||a})},decodeAndVerifyParams:function(a,b){if(!a)return null;a=decodeURIComponent(a),a=decodeURIComponent(a),a=new Buffer(a,"base64").toString("utf-8");var c=a.split("."),d=c[0].trim(),e=c[1],f=crypto.createHmac("sha256",b).update(e).digest();if(f=new Buffer(f).toString("base64").trim(),d!=f)return null;var g=new Buffer(e,"base64").toString("utf-8");return JSON.parse(g)},extend:function(a){for(var b=function(a,b){for(var c in b)hasOwnProperty.call(b,c)&&(a[c]=b[c]);return a},c=1;c<arguments.length;c++)a=b(a,arguments[c]);return a}},Tr8n.Configuration=function(){this.initDefaultTokens(),this.initTranslatorOptions(),this.initContextRules(),this.enabled=!0,this.default_locale="en-US"},Tr8n.Configuration.prototype={initDefaultTokens:function(){this.default_tokens={html:{data:{ndash:"&ndash;",mdash:"&mdash;",iexcl:"&iexcl;",iquest:"&iquest;",quot:"&quot;",ldquo:"&ldquo;",rdquo:"&rdquo;",lsquo:"&lsquo;",rsquo:"&rsquo;",laquo:"&laquo;",raquo:"&raquo;",nbsp:"&nbsp;",lsaquo:"&lsaquo;",rsaquo:"&rsaquo;",br:"<br/>",lbrace:"{",rbrace:"}",trade:"&trade;"},decoration:{strong:"<strong>{$0}</strong>",bold:"<strong>{$0}</strong>",b:"<strong>{$0}</strong>",em:"<em>{$0}</em>",italic:"<i>{$0}</i>",i:"<i>{$0}</i>",link:"<a href='{$href}'>{$0}</a>",br:"<br>{$0}",strike:"<strike>{$0}</strike>",div:"<div id='{$id}' class='{$class}' style='{$style}'>{$0}</div>",span:"<span id='{$id}' class='{$class}' style='{$style}'>{$0}</span>",h1:"<h1>{$0}</h1>",h2:"<h2>{$0}</h2>",h3:"<h3>{$0}</h3>"}},text:{data:{ndash:"–",mdash:"-",iexcl:"¡",iquest:"¿",quot:'"',ldquo:"“",rdquo:"”",lsquo:"‘",rsquo:"’",laquo:"«",raquo:"»",nbsp:" ",lsaquo:"‹",rsaquo:"›",br:"\n",lbrace:"{",rbrace:"}",trade:"™"},decoration:{strong:"{$0}",bold:"{$0}",b:"{$0}",em:"{$0}",italic:"{$0}",i:"{$0}",link:"{$0}{$1}",br:"\n{$0}",strike:"{$0}",div:"{$0}",span:"{$0}",h1:"{$0}",h2:"{$0}",h3:"{$0}"}}}},getDefaultToken:function(a,b,c){return b=b||"data",c=c||"html","undefined"==typeof this.default_tokens[c][b][a]?null:new String(this.default_tokens[c][b][a])},setDefaultToken:function(a,b,c,d){c=c||"data",d=d||"html",this.default_tokens[d]=this.default_tokens[d]||{},this.default_tokens[d][c]=this.default_tokens[d][c]||{},this.default_tokens[d][c][a]=b},initTranslatorOptions:function(){this.translator_options={debug:!0,debug_format_html:"<span style='font-size:20px;color:red;'>{</span> {$0} <span style='font-size:20px;color:red;'>}</span>",debug_format:"{{{{$0}}}}",split_sentences:!1,nodes:{ignored:[],scripts:["style","script"],inline:["a","span","i","b","img","strong","s","em","u","sub","sup"],"short":["i","b"],splitters:["br","hr"]},attributes:{labels:["title","alt"]},name_mapping:{b:"bold",i:"italic",a:"link",img:"picture"},data_tokens:{special:!1,numeric:!1,numeric_name:"num"}}},initContextRules:function(){this.context_rules={number:{variables:{}},gender:{variables:{"@gender":"gender"}},genders:{variables:{"@genders":function(a){var b=[];return a.forEach(function(a){b.push(a.gender)}),b}}},date:{variables:{}},time:{variables:{}}}},getContextRules:function(a){return this.context_rules[a]||{}},isDisabled:function(){return!this.isEnabled()},isEnabled:function(){return this.enabled},getSupportedTokens:function(){return[[/(\{[^_:][\w]*(:[\w]+)*(::[\w]+)*\})/g,Tr8n.Tokens.Data],[/(\{[^_:.][\w]*(\.[\w]+)(:[\w]+)*(::[\w]+)*\})/g,Tr8n.Tokens.Method],[/(\{[^_:|][\w]*(:[\w]+)*(::[\w]+)*\s*\|\|?[^{^}]+\})/g,Tr8n.Tokens.Piped]]}},Tr8n.Logger={log:function(a){console.log(new Date+": "+a)}},Tr8n.Tokens.Data=function(a,b){a&&(this.full_name=a,this.label=b,this.parseElements())},Tr8n.Tokens.Data.prototype={parseElements:function(){var a=this.full_name.substring(1,this.full_name.length-1),b=a.split("::")[0].trim();this.short_name=a.split(":")[0].trim(),this.case_keys=[];for(var c=a.match(/(::\s*\w+)/g)||[],d=0;d<c.length;d++)this.case_keys.push(c[d].replace(/[:]/g,"").trim());for(this.context_keys=[],c=b.match(/(:\s*\w+)/g)||[],d=0;d<c.length;d++)this.context_keys.push(c[d].replace(/[:]/g,"").trim())},getContextForLanguage:function(a){return this.context_keys.length>0?a.getContextByKeyword(this.context_keys[0]):a.getContextByTokenName(this.short_name)},getTokenObject:function(a,b){if(!a)return null;b=b||this.short_name;var c=a[b];return Tr8n.Utils.isArray(c)?c[0]:c.object||c},error:function(a){return console.log(this.full_name+' in "'+this.label+'" : '+a),this.full_name},getTokenValueFromArrayParam:function(a,b,c){if(c=c||{},0==a.length)return this.error("Invalid number of params of an array");var d=a[0],e=a.length>1?a[1]:null;return Tr8n.Utils.isArray(d)?this.getTokenValueFromArray(a,b,c):e?this.sanitize(e.toString(),d,b,Tr8n.Utils.extend(c,{safe:!0})):this.sanitize(d.toString(),d,b,Tr8n.Utils.extend(c,{safe:!1}))},getTokenValueFromHashParam:function(a,b,c){c=c||{};var d=a.value,e=a.object;if(d)return this.sanitize(d,e||a,b,Tr8n.Utils.extend(c,{safe:!0}));if(!e)return this.sanitize(a.toString(),e,b,Tr8n.Utils.extend(c,{safe:!1}));var f=a.attribute;return f?this.sanitize(e[f],e,b,Tr8n.Utils.extend(c,{safe:!1})):this.error("Missing value for hash token")},getTokenValueFromArray:function(a,b,c){var d={description:"List joiner",limit:4,separator:", ",joiner:"and",less:"{laquo} less",expandable:!1,collapsable:!0};c=c||{};var e=a[0],f=a.length>1?a[1]:null;a.length>2&&(d=Tr8n.Utils.extend(d,a[2])),c.skip_decorations&&(d.expandable=!1);for(var g=[],h=0;h<e.length;h++){var i=e[h];if(null==f)g.push(this.sanitize(""+i,i,b,Tr8n.Utils.extend(c,{safe:!1})));else if("string"==typeof f)if(f.match(/^@/)){var j=f.replace(/^@/,"");g.push(this.sanitize(i[j]||i[j](),i,b,Tr8n.Utils.extend(c,{safe:!1})))}else g.push(f.replace("{$0}",this.sanitize(""+i,i,b,Tr8n.Utils.extend(c,{safe:!1}))));else if(Tr8n.Utils.isObject(f)){var k=f.attribute,l=f.value;if(!k)return this.error("No attribute is provided for the hash object in the array");if(!i[k])return this.error("Hash object in the array does not contain such attribute");k=this.sanitize(i[k],i,b,Tr8n.Utils.extend(c,{safe:!1})),g.push(l?l.replace("{$0}",k):k)}else"function"==typeof f&&g.push(this.sanitize(f(i),i,b,Tr8n.Utils.extend(c,{safe:!0})))}if(1==g.length)return g[0];if(!d.joiner||""==d.joiner)return g.join(d.separator);var m=b.translate(d.joiner,d.description,{},c);if(g.length<=d.limit){var n=g.pop();return g.join(d.separator)+" "+m+" "+n}var o=g.slice(0,d.limit),p=g.slice(d.limit),q=o.join(d.separator),r=b.translate("{count||other}",d.description,{count:p.length},c);if(!d.expandable)return q=q+" "+m+" ",Tr8n.Utils.isFunction(d)?q+d.remainder(p):q+r;var s=d.key?d.key:Tr8n.Utils.generateKey(this.label,g.join(","));q=q+'<span id="tr8n_other_link_'+s+'"> '+m+" ",q+="<a href=\"#\" class=\"tr8n_other_list_link\" onClick=\"document.getElementById('tr8n_other_link_key').style.display='none'; document.getElementById('tr8n_other_elements_key').style.display='inline'; return false;\">",q+=d.remainder&&"function"==typeof d.remainder?d.remainder(p):r,q+="</a></span>",q=q+'<span id="tr8n_other_elements_'+s+'" style="display:none">'+d.separator;var t=p.pop();return q+=p.join(d.separator),q=q+" "+m+" "+t,d.collapsable&&(q+=" <a href=\"#\" class=\"tr8n_other_less_link\" style=\"font-size:smaller;white-space:nowrap\" onClick=\"document.getElementById('tr8n_other_link_key').style.display='inline'; document.getElementById('tr8n_other_elements_key').style.display='none'; return false;\">",q+=b.translate(d.less,d.description,{},c),q+="</a>"),q+="</span>"},getTokenValue:function(a,b,c){a=a||{},c=c||{};var d=a[this.short_name]||Tr8n.config.getDefaultToken(this.short_name);return d?"string"==typeof d?this.sanitize(d.toString(),d,b,Tr8n.Utils.extend(c,{safe:!0})):Tr8n.Utils.isArray(d)?this.getTokenValueFromArrayParam(d,b,c):Tr8n.Utils.isObject(d)?this.getTokenValueFromHashParam(d,b,c):this.sanitize(d.toString(),d,b,Tr8n.Utils.extend(c,{safe:!1})):this.error("Missing token value")},applyCase:function(a,b,c,d,e){var f=d.getLanguageCaseByKeyword(a);return f?f.apply(b,c,e):b},sanitize:function(a,b,c,d){if(d=d||{},a=a.toString(),d.safe||(a=Tr8n.Utils.escapeHTML(a)),this.case_keys.length>0)for(var e=0;e<this.case_keys.length;e++)a=this.applyCase(this.case_keys[e],a,b,c,d);return a},substitute:function(a,b,c,d){return a.replace(this.full_name,this.getTokenValue(b,c,d))}},Tr8n.Tokens.Method=function(a,b){a&&(this.full_name=a,this.label=b,this.parseElements(),this.initObject())},Tr8n.Tokens.Method.prototype=new Tr8n.Tokens.Data,Tr8n.Tokens.Method.prototype.constructor=Tr8n.Tokens.Method,Tr8n.Tokens.Method.prototype.initObject=function(){var a=this.short_name.split(".");this.short_name=a[0],this.object_method=a[1]},Tr8n.Tokens.Method.prototype.getTokenValue=function(a){a=a||{};var b=a[this.short_name];if(!b)return this.error("Missing token value");var c=b[this.object_method]||b[this.object_method]();return c||c.toString()},Tr8n.Tokens.Method.prototype.substitute=function(a,b,c,d){return a.replace(this.full_name,this.sanitize(this.getTokenValue(b),this.getTokenObject(b),c,Tr8n.Utils.extend(d,{safe:!1})))},Tr8n.Tokens.Piped=function(a,b){a&&(this.full_name=a,this.label=b,this.parseElements())},Tr8n.Tokens.Piped.prototype=new Tr8n.Tokens.Data,Tr8n.Tokens.Piped.prototype.constructor=Tr8n.Tokens.Piped,Tr8n.Tokens.Piped.prototype.parseElements=function(){var a=this.full_name.substring(1,this.full_name.length-1),b=a.split("|"),c=b[0].trim();this.short_name=c.split(":")[0].trim(),this.case_keys=[];for(var d=c.match(/(::\s*\w+)/g)||[],e=0;e<d.length;e++)this.case_keys.push(d[e].replace(/[:]/g,"").trim());this.context_keys=[];var f=c.split("::")[0].trim();for(d=f.match(/(:\s*\w+)/g)||[],e=0;e<d.length;e++)this.context_keys.push(d[e].replace(/[:]/g,"").trim());if(this.separator=-1!=this.full_name.indexOf("||")?"||":"|",this.parameters=[],b=a.split(this.separator),b.length>1)for(b=b[1].split(","),e=0;e<b.length;e++)this.parameters.push(b[e].trim())},Tr8n.Tokens.Piped.prototype.isValueDisplayedInTranslation=function(){return"||"==this.separator},Tr8n.Tokens.Piped.prototype.generateValueMapForContext=function(a){var b={};if(-1!=this.parameters[0].indexOf(":")){for(var c=0;c<this.parameters.length;c++){var d=this.parameters[c].split(":");b[d[0].trim()]=d[1].trim()}return b}var e=a.token_mapping;if(!e)return this.error("The token context "+a.keyword+"does not support transformation for unnamed params"),null;if("string"==typeof e)return this.error("The token mapping "+e+" does not support the parameters."),null;if(Tr8n.Utils.isArray(e)){if(this.parameters.length>e.length)return this.error("The token mapping "+e+" does not support "+this.parameters.length+" parameters"),null;if(e=e[this.parameters.length-1],"string"==typeof e)return this.error("The token mapping "+e+" does not support "+this.parameters.length+" parameters"),null}for(var f=Tr8n.Utils.keys(e),c=0;c<f.length;c++){var g=f[c],h=e[g];b[g]=h;for(var i=h.match(/{\$\d(::[\w]+)*\}/g)||[],j=0;j<i.length;j++){var k=i[j],l=k.replace(/[\{\}]/g,""),m=l.split("::"),n=parseInt(m[0].replace(/[$]/,""));if(this.parameters.length<n)return this.error("The index inside "+e+" is out of bound: "+this.full_name),null;var o=this.parameters[n];m.shift();for(var p=0;p<m.length;p++){var q=a.language.getLanguageCaseByKeyword(m[p]);q&&(o=q.apply(o))}b[g]=b[g].replace(i[j],o)}}return b},Tr8n.Tokens.Piped.prototype.substitute=function(a,b,c,d){if(!b[this.short_name])return this.error("Missing value"),a;var e=this.getTokenObject(b);if(0==this.parameters.length)return this.error("Piped params may not be empty"),a;var f=this.getContextForLanguage(c),g=this.generateValueMapForContext(f);if(!g)return a;var h=f.findMatchingRule(e);if(null==h)return a;var i=g[h.keyword];if(!i){var j=f.getFallbackRule();if(!j||!g[j.keyword])return this.error("No matching context rule found and no fallback provided"),a;i=g[j.keyword]}var k=[];return this.isValueDisplayedInTranslation()?(k.push(this.getTokenValue(b,c,d)),k.push(" ")):i=i.replace("#"+this.short_name+"#",this.getTokenValue(b,c,d)),k.push(i),a.replace(this.full_name,k.join(""))},Tr8n.RulesEngine.Evaluator=function(a){return this.vars={},this.ctx=a||{label:function(a,b){return this.vars[a]=this.ctx[a]=b,b},quote:function(a){return a},car:function(a){return a[1]},cdr:function(a){return a.shift(),a},cons:function(a,b){return b.unshift(a),b},eq:function(a,b){return a==b},atom:function(a){return!(typeof a in{object:1,array:1,"function":1})},cond:function(a,b,c){return this.evaluate(this.evaluate(a)?b:c)},set:function(a,b){return this.vars[a]=this.ctx[a]=b,b},"=":function(a,b){return a==b},"!=":function(a,b){return a!=b},"<":function(a,b){return b>a},">":function(a,b){return a>b},"+":function(a,b){return a+b},"-":function(a,b){return a-b},"*":function(a,b){return a*b},"%":function(a,b){return a%b},mod:function(a,b){return a%b},"/":function(a,b){return 1*a/b},"!":function(a){return!a},not:function(a){return!a},"&&":function(){return Array.prototype.slice.call(arguments).every(this.evaluate.bind(this))},and:function(){return Array.prototype.slice.call(arguments).every(this.evaluate.bind(this))},"||":function(){return!!Array.prototype.slice.call(arguments).filter(this.evaluate.bind(this)).length},or:function(){return!!Array.prototype.slice.call(arguments).filter(this.evaluate.bind(this)).length},"if":function(a,b,c){return this.evaluate(this.evaluate(a)?b:c)},let:function(a,b){return this.vars[a]=b},"true":function(){return!0},"false":function(){return!1},date:function(a){return new Date(a)},today:function(){return new Date},time:function(a){return new Date(a)},now:function(){return Date.now()},append:function(a,b){return String(b)+String(a)},prepend:function(a,b){return String(a)+String(b)},match:function(a,b){return a=this._stringToRegexp(a),!!b.match(a)},"in":function(a,b){var c,d=this._range;return a=a.replace(/\s/g,"").replace(/(\w+)\.\.(\w+)/g,function(a,b,e){return c=d(b,e),c.push(e),c.join()}),-1!=a.split(",").indexOf(String(b))},within:function(a,b){var c=a.split("..").map(function(a){return parseInt(a)});return c[0]<=b&&b<=c[1]},replace:function(a,b,c){return a=this._stringToRegexp(a),c.replace(a,b)},count:function(a){return("string"==typeof a?this.vars[a]:a).length},all:function(a,b){return a="string"==typeof a?this.vars[a]:a,a instanceof Array?a.every(function(a){return a==b}):!1},any:function(a,b){return a="string"==typeof a?this.vars[a]:a,a instanceof Array?!!a.filter(function(a){return a==b}):!1}},this},Tr8n.RulesEngine.Evaluator.prototype={_range:function(a,b){var c=[],d=!String(a).match(/^\d+$/);for(a=d?a.charCodeAt(0):parseInt(a),b=d?b.charCodeAt(0):parseInt(b);b>=a;)c.push(d?String.fromCharCode(a):String(a)),a+=1;return c},_stringToRegexp:function(a){var b=new RegExp("^/","g");return a.match(b)?(a=a.replace(b,""),a.match(/\/i$/)?(a=a.replace(/\/i$/g,""),new RegExp(a,"ig")):(a=a.replace(/\/$/,""),new RegExp(a,"g"))):new RegExp(a,"g")},setVars:function(a){this.vars=a},getVars:function(){return this.vars},apply:function(a,b){return"function"==typeof this.ctx[a]?this.ctx[a].apply(this,b):this.ctx[a]},evaluate:function(a){if(this.ctx.atom.call(this,a))return"string"==typeof a&&this.vars[a]?this.vars[a]:a in this.ctx?this.ctx[a]:a;var b=a[0],c=a.slice(1);return-1==["quote","car","cdr","cond","if","&&","||","and","or","true","false","let","count","all","any"].indexOf(b)&&(c=c.map(this.evaluate.bind(this))),this.apply(b,c)}},Tr8n.RulesEngine.Parser=function(a){this.tokenize(a)},Tr8n.RulesEngine.Parser.prototype={tokenize:function(a){this.tokens=a.match(/[()]|\w+|@\w+|[\+\-\!\|\=>&<\*\/%]+|\".*?\"|'.*?'/g)},parse:function(){return(token=this.tokens.shift())?"("==token?this.parseList():token.match(/^['"].*/)?token.slice(1,-1):token.match(/\d+/)?parseInt(token):String(token):void 0},parseList:function(){for(var a=[];this.tokens.length>0&&")"!=this.tokens[0];)a.push(this.parse());return this.tokens.shift(),a}},Tr8n.Tokenizers.Data=function(a){this.label=a,this.tokenize()},Tr8n.Tokenizers.Data.prototype={tokenize:function(){this.tokens=[];for(var a=Tr8n.config.getSupportedTokens(),b=""+this.label,c=0;c<a.length;c++){for(var d=a[c],e=b.match(d[0])||[],f=0;f<e.length;f++)this.tokens.push(new d[1](e[f],this.label));b=b.replace(a[c][0],"")}},isTokenAllowed:function(a,b){return b.allowed_tokens?-1!=b.allowed_tokens.indexOf(a):!0},substitute:function(a,b,c){c=c||{};for(var d=this.label,e=0;e<this.tokens.length;e++){var f=this.tokens[e];this.isTokenAllowed(f.name,c)&&(d=f.substitute(d,b,a,c))}return d}};var RESERVED_TOKEN="tr8n",RE_SHORT_TOKEN_START="\\[[\\w]*:",RE_SHORT_TOKEN_END="\\]",RE_LONG_TOKEN_START="\\[[\\w]*\\]",RE_LONG_TOKEN_END="\\[\\/[\\w]*\\]",RE_TEXT="[^\\[\\]]+",TOKEN_TYPE_SHORT="short",TOKEN_TYPE_LONG="long",PLACEHOLDER="{$0}";Tr8n.Tokenizers.Decoration=function(a){this.label="["+RESERVED_TOKEN+"]"+a+"[/"+RESERVED_TOKEN+"]",this.fragments=[],this.tokens=[],this.tokenize()},Tr8n.Tokenizers.Decoration.prototype={tokenize:function(){var a=new RegExp([RE_SHORT_TOKEN_START,RE_SHORT_TOKEN_END,RE_LONG_TOKEN_START,RE_LONG_TOKEN_END,RE_TEXT].join("|"),"g");return this.fragments=this.label.match(a),this.fragments},peek:function(){return 0==this.fragments.length?null:this.fragments[0]},getNextFragment:function(){return 0==this.fragments.length?null:this.fragments.shift()},parse:function(){var a=this.getNextFragment();return a.match(new RegExp(RE_SHORT_TOKEN_START))?this.parseTree(a.replace(/[\[:]/g,""),TOKEN_TYPE_SHORT):a.match(new RegExp(RE_LONG_TOKEN_START))?this.parseTree(a.replace(/[\[\]]/g,""),TOKEN_TYPE_LONG):a},parseTree:function(a,b){var c=[a];if(-1==this.tokens.indexOf(a)&&a!=RESERVED_TOKEN&&this.tokens.push(a),b==TOKEN_TYPE_SHORT)for(var d=!0;null!=this.peek()&&!this.peek().match(new RegExp(RE_SHORT_TOKEN_END));){var e=this.parse();d&&"string"==typeof e&&(e=e.replace(/^\s+/,""),d=!1),c.push(e)}else if(b==TOKEN_TYPE_LONG)for(;null!=this.peek()&&!this.peek().match(new RegExp(RE_LONG_TOKEN_END));)c.push(this.parse());return this.getNextFragment(),c},isTokenAllowed:function(a){return!this.options.allowed_tokens||-1!=this.options.allowed_tokens.indexOf(a)},getDefaultDecoration:function(a,b){var c=Tr8n.config.getDefaultToken(a,"decoration");if(null==c)return b;var d=this.context[a];if(c=c.replace(PLACEHOLDER,b),d instanceof Object)for(var e=Tr8n.Utils.keys(d),f=0;f<e.length;f++)c=c.replace("{$"+e[f]+"}",d[e[f]]);return c},apply:function(a,b){if(a==RESERVED_TOKEN)return b;if(!this.isTokenAllowed(a))return b;var c=this.context[a];return null!=c?"string"==typeof c?c.replace(PLACEHOLDER,b):"function"==typeof c?c(b):"object"==typeof c?this.getDefaultDecoration(a,b):b:this.getDefaultDecoration(a,b)},evaluate:function(a){if(!(a instanceof Array))return a;var b=a[0];a.shift();for(var c=this,d=[],e=0;e<a.length;e++)d.push(c.evaluate(a[e]));return this.apply(b,d.join(""))},substitute:function(a,b){return this.context=a||{},this.options=b||{},this.evaluate(this.parse())}};var HTML_SPECIAL_CHAR_REGEX="/(&[^;]*;)/",INDEPENDENT_NUMBER_REGEX="/^(\\d+)$|^(\\d+[,;\\s])|(\\s\\d+)$|(\\s\\d+[,;\\s])/",VERBOSE_DATE_REGEX="/(((Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)|(January|February|March|April|May|June|July|August|September|October|November|December))\\s\\d+(,\\s\\d+)*(,*\\sat\\s\\d+:\\d+(\\sUTC))*)/";Tr8n.Tokenizers.Dom=function(a,b,c){this.doc=a,this.context=b||{},this.tokens=[],this.options=c||{}},Tr8n.Tokenizers.Dom.prototype={translate:function(){return this.translateTree(this.doc)},translateTree:function(a){if(this.isNonTranslatableNode(a))return 1==a.childNodes.length?a.childNodes[0].nodeValue:"";if(3==a.nodeType)return this.translateTml(a.nodeValue);for(var b="",c="",d=0;d<a.childNodes.length;d++){var e=a.childNodes[d];if(3==e.nodeType)c+=e.nodeValue;else if(this.isInlineNode(e)&&this.hasInlineOrTextSiblings(e)&&!this.isBetweenSeparators(e))c+=this.generateTmlTags(e);else if(this.isSeparatorNode(e))""!=c&&(b+=this.translateTml(c)),b+=this.generateHtmlToken(e),c="";else{""!=c&&(b+=this.translateTml(c));var f=this.translateTree(e);b+=this.isIgnoredNode(e)?f:this.generateHtmlToken(e,f),c=""}}return""!=c&&(b+=this.translateTml(c)),b},isNonTranslatableNode:function(a){return 1==a.nodeType&&-1!=this.getOption("nodes.scripts").indexOf(a.nodeName.toLowerCase())?!0:1==a.nodeType&&0==a.childNodes.length&&""==a.nodeValue?!0:!1},translateTml:function(a){if(this.isEmptyString(a))return a;if(this.getOption("split_sentences")){sentences=Tr8n.Utils.splitSentences(a),translation=a;var b=this;return sentences.forEach(function(a){var c=b.getOption("debug")?b.debugTranslation(a):Tr8n.config.currentLanguage.translate(a,null,b.tokens,b.options);translation=translation.replace(a,c)}),this.resetContext(),translation}return translation=this.getOption("debug")?this.debugTranslation(a):Tr8n.config.currentLanguage.translate(a,null,this.tokens,this.options),this.resetContext(),translation},hasChildNodes:function(a){return a.childNodes?a.childNodes.length>0:!1},isBetweenSeparators:function(a){return this.isSeparatorNode(a.previousSibling)&&!this.isValidTextNode(a.nextSibling)?!0:this.isSeparatorNode(a.nextSibling)&&!this.isValidTextNode(a.previousSibling)?!0:!1},generateTmlTags:function(a){for(var b="",c=this,d=0;d<a.childNodes.length;d++){var e=a.childNodes[d];b+=3==e.nodeType?e.nodeValue:c.generateTmlTags(e)}var f=c.generateHtmlToken(a),g=this.contextualize(this.adjustName(a),f),h=this.sanitizeValue(b);return this.isSelfClosingNode(a)?"{"+g+"}":this.isShortToken(g,h)?"["+g+": "+h+"]":"["+g+"]"+h+"[/"+g+"]"},getOption:function(a){return this.options[a]?this.options[a]:Tr8n.Utils.hashValue(Tr8n.config.translator_options,a)},debugTranslation:function(a){return this.getOption("debug_format").replace("{$0}",a)},isEmptyString:function(a){return a=a.replace(/[\s\n\r\t\0\x0b\xa0\xc2]/g,""),""==a},resetContext:function(){this.tokens=[].concat(this.context)},isShortToken:function(a,b){return-1!=this.getOption("nodes.short").indexOf(a.toLowerCase())||b.length<20},isOnlyChild:function(a){return null==a.parentNode?!1:1==a.parentNode.childNodes.length},hasInlineOrTextSiblings:function(a){if(null==a.parentNode)return!1;for(var b=0;b<a.parentNode.childNodes.length;b++){var c=a.parentNode.childNodes[b];if(c!=a&&(this.isInlineNode(c)||this.isValidTextNode(c)))return!0}return!1},isInlineNode:function(a){return 1==a.nodeType&&-1!=this.getOption("nodes.inline").indexOf(a.tagName.toLowerCase())&&!this.isOnlyChild(a)},isContainerNode:function(a){return 1==a.nodeType&&!this.isInlineNode(a)},isSelfClosingNode:function(a){return null==a.firstChild},isIgnoredNode:function(a){return 1!=a.nodeType?!0:-1!=this.getOption("nodes.ignored").indexOf(a.tagName.toLowerCase())},isValidTextNode:function(a){return null==a?!1:3==a.nodeType&&!this.isEmptyString(a.nodeValue)},isSeparatorNode:function(a){return null==a?!1:1==a.nodeType&&-1!=this.getOption("nodes.splitters").indexOf(a.tagName.toLowerCase())},sanitizeValue:function(a){return a.replace(/^\s+/,"")},replaceSpecialCharacters:function(a){if(!this.getOption("data_tokens.special"))return a;var b=a.match(HTML_SPECIAL_CHAR_REGEX),c=this;return b.forEach(function(b){token=b.substring(1,b.length-2),c.context[token]=b,a=a.replace(b,"{"+token+"}")}),a},generateDataTokens:function(a){if(!this.getOption("data_tokens.numeric"))return a;var b=a.match(INDEPENDENT_NUMBER_REGEX),c=this.getOption("data_tokens.numeric_name"),d=this;return b.forEach(function(b){value=b.replace(/[,;]\s/,""),token=d.contextualize(c,value),a=a.replace(b,b.replace(value,"{"+token+"}"))}),a},generateHtmlToken:function(a,b){var c=a.tagName.toLowerCase(),d=a.attributes,e={},b=null==b?"{0}":b;if(0==d.length)return this.isSelfClosingNode(a)?"<"+c+"/>":"<"+c+">"+b+"</"+c+">";for(var f=0;f<d.length;f++)e[d[f].name]=d[f].value;var g=Tr8n.Utils.keys(e);g.sort();var h=[];return g.forEach(function(a){var b=-1!=e[a].indexOf("'")?'"':"'";h.push(a+"="+b+e[a]+b)}),h=h.join(" "),this.isSelfClosingNode(a)?"<"+c+" "+h+"/>":"<"+c+" "+h+">"+b+"</"+c+">"},adjustName:function(a){var b=a.tagName.toLowerCase(),c=this.getOption("name_mapping");return b=null!=c[b]?c[b]:b},contextualize:function(a,b){if(this.tokens[a]&&this.tokens[a]!=b){var c=0,d=a.match(/\d+$/);return d&&d.length>0&&(c=parseInt(d[d.length-1]),a=a.replace(""+c,"")),a+=c+1,this.contextualize(a,b)}return this.tokens[a]=b,a},debug:function(a){this.doc=a,this.debugTree(a,0)},debugTree:function(a,b){var c=new Array(b+1).join("=");if(console.log(c+"=> "+typeof a+": "+this.nodeInfo(a)),a.childNodes)for(var d=this,e=0;e<a.childNodes.length;e++){var f=a.childNodes[e];
d.debugTree(f,b+1)}},nodeInfo:function(a){var b=[];return b.push(a.nodeType),1==a.nodeType&&b.push(a.tagName),this.isInlineNode(a)&&(b.push("inline"),b.push(this.hasInlineOrTextSiblings(a)?"sentence":"only translatable")),this.isSelfClosingNode(a)&&b.push("self closing"),this.isOnlyChild(a)&&b.push("only child"),3==a.nodeType?"["+b.join(", ")+']: "'+a.nodeValue+'"':"["+b.join(", ")+"]"}},Tr8n.Decorators.Html={decorate:function(a,b,c,d,e){if(e=e||{},e.skip_decorations||d.language==c||!e.current_translator||!e.current_translator.inline||d.locked&&!e.current_translator.manager)return a;var f="tr8n:tr",g=["tr8n_translatable"];if(d.locked){if(!e.current_translator.isFeatureEnabled("show_locked_keys"))return a;g.push("tr8n_locked")}else g.push(b==d.language?"tr8n_not_translated":b==c?"tr8n_translated":"tr8n_fallback");var h=[];return h.push("<"+f+" class='"+g.join(" ")+"' data-translation_key='"+d.key+"'>"),h.push(a),h.push("</"+f+">"),h.join("")}},Tr8n.Application=function(a){Tr8n.Utils.extend(this,a),this.languages=[];for(var b in a.languages||[])this.languages.push(new Tr8n.Language(Tr8n.Utils.extend(b,{application:this})));this.default_locale=Tr8n.config.default_locale,this.languages_by_locale={}},Tr8n.Application.prototype={addLanguage:function(a){a.application=this,this.languages_by_locale[a.locale]=a},getLanguage:function(a){return this.languages_by_locale[a||this.default_locale]},isFeatureEnabled:function(a){return this.features&&this.features[a]},getApiClient:function(){return this.api_client||(this.api_client=new Tr8n.ApiClient(this)),this.api_client},init:function(a,b){a=a||{},this.getApiClient().get("application",{definition:!0},function(c,d){if(c)throw console.log(err),err;Tr8n.Utils.extend(this,d),a.locales?this.loadLanguages(a.locales,function(){b(null)}):b(null)}.bind(this))},loadLanguages:function(a,b){var c=require("async"),d={},e=this;a.forEach(function(a){d[a]=function(b){e.getApiClient().get("language",{locale:a,definition:!0},function(a,c){return a?void b(a,null):void b(null,new Tr8n.Language(c))})}}),c.parallel(d,function(a,c){if(a)throw console.log(a),a;Object.keys(c).forEach(function(a){e.addLanguage(c[a])}),b()})},loadDefaultLanguages:function(a,b){var c=require("async"),d=require("fs"),e={},f=this;a.forEach(function(a){e[a]=function(b){var c=__dirname+"/../config/data/"+a+".json";console.log("Loading "+c+" ..."),d.readFile(c,function(a,c){if(a)throw console.log(a),a;b(null,new Tr8n.Language(JSON.parse(c)))})}}),c.parallel(e,function(a,c){if(a)throw console.log(a),a;Object.keys(c).forEach(function(a){f.addLanguage(e[a])}),b()})},submitMissingTranslationKeys:function(){console.log("Submitting missing translation keys...")}},Tr8n.Source=function(a){Tr8n.Utils.extend(this,a)};var request=require("request"),API_HOST="https://translationexchange.com",API_PATH="/tr8n/api/";Tr8n.ApiClient=function(a){this.application=a},Tr8n.ApiClient.prototype={getHost:function(){return this.application.host||API_HOST},getAccessToken:function(a){return this.application.access_token?void a(error,this.application.access_token):void this.api("oauth/request_token",{client_id:this.application.key,client_secret:this.application.secret,grant_type:"client_credentials"},function(b,c){b||(this.application.access_token=c),a(b,c)}.bind(this))},get:function(a,b,c,d){c=c||{},c.method="get",this.api(a,b,c,d)},post:function(a,b,c,d){c=c||{},c.method="post",this.api(a,b,c,d)},api:function(a,b,c,d){c=c||{},Tr8n.Utils.isFunction(b)?(d=b,b={}):Tr8n.Utils.isFunction(c)&&(d=c,c={});var e=function(a,b,c){a||200!=b.statusCode?d(a,c):d(a,JSON.parse(c))};Tr8n.Utils.extend(b,{key:this.application.key});var f=this.getHost()+API_PATH+a;console.log("Requesting "+f+" with params: "),console.log(b),"post"==c.method?this.getAccessToken(function(a,c){Tr8n.Utils.extend(b,{access_token:c.access_token}),request.post(f,{qs:b},e)}.bind(this)):request.get(f,{qs:b},e)}},Tr8n.TranslationKey=function(a){Tr8n.Utils.extend(this,a),this.key=this.key||Tr8n.Utils.generateKey(this.label,this.description),!this.locale&&this.application&&(this.locale=this.application.default_locale),!this.language&&this.application&&(this.language=this.application.language(this.locale)),this.addTranslations(a.translations||{})},Tr8n.TranslationKey.prototype={addTranslation:function(a){this.translations||(this.translations={}),this.translations[a.locale]||(this.translations[a.locale]=[]),this.translations[a.locale].push(new Tr8n.Translation(Tr8n.Utils.extend(a,{translation_key:this})))},addTranslations:function(a){for(var b in Tr8n.Utils.keys(a||{}))for(var c in a[b])this.addTranslation(c)},resetTranslations:function(){this.translations={}},getTranslationsForLanguage:function(a){return this.translations?this.translations[a.locale]||[]:[]},findFirstValidTranslation:function(a,b){for(var c=this.getTranslationsForLanguage(a),d=0;d<c.length;d++)if(c[d].isValidTranslation(b))return c[d];return null},translate:function(a,b,c){if(c=c||{},Tr8n.config.isDisabled())return this.substituteTokens(this.label,b,a,c);var d=this.findFirstValidTranslation(a,b),e=Tr8n.Decorators.Html;return d?e.decorate(this.substituteTokens(d.label,b,d.language,c),d.language,a,this,c):e.decorate(this.substituteTokens(this.label,b,this.language||a,c),this.language||a,a,this,c)},getDataTokens:function(){if(!this.data_tokens){var a=new Tr8n.Tokenizers.Data(this.label);this.data_tokens=a.tokens}return this.data_tokens},getDataTokenNames:function(){if(!this.data_token_names){this.data_token_names=[];for(var a in this.getDataTokens())this.data_token_names.push(a.full_name)}return this.data_token_names},getDecorationTokenNames:function(){if(!this.decoration_tokens){var a=new Tr8n.Tokenizers.Decoration(this.label);a.parse(),this.decoration_tokens=a.tokens}return this.decoration_tokens},substituteTokens:function(a,b,c,d){if(-1!=a.indexOf("{")){var e=new Tr8n.Tokenizers.Data(a);a=e.substitute(c,b,Tr8n.Utils.extend(d,{allowed_tokens:this.getDataTokenNames()}))}return-1!=a.indexOf("[")&&(e=new Tr8n.Tokenizers.Decoration(a),a=e.substitute(b,Tr8n.Utils.extend(d,{allowed_tokens:this.getDecorationTokenNames()}))),a}},Tr8n.Translation=function(a){Tr8n.Utils.extend(this,a),!this.language&&this.locale&&this.translation_key&&(this.language=this.translation_key.application.getLanguage(this.locale))},Tr8n.Translation.prototype={hasContextRules:function(){return this.context&&Tr8n.Utils.keys(this.context).length>0},isValidTranslation:function(a){if(!this.hasContextRules())return!0;for(var b=Tr8n.Utils.keys(this.context),c=0;c<b.length;c++){var d=b[c],e=this.context[d],f=Tr8n.Tokens.Data.prototype.getTokenObject(a,d);if(!f)return!1;for(var g=Tr8n.Utils.keys(e),h=0;h<g.length;h++){var i=g[h],j=e[g[h]];if("other"!=j){var k=this.language.getContextByKeyword(i);if(!k)return!1;var l=k.findMatchingRule(f);if(!l||l.keyword!=j)return!1}}}return!0}},Tr8n.Translator=function(a){Tr8n.Utils.extend(this,a)},Tr8n.Language=function(a){Tr8n.Utils.extend(this,a),this.contexts={};for(var b=Tr8n.Utils.keys(a.contexts||{}),c=0;c<b.length;c++)this.contexts[b[c]]=new Tr8n.LanguageContext(Tr8n.Utils.extend(a.contexts[b[c]],{language:this}));for(this.cases={},b=Tr8n.Utils.keys(a.cases||{}),c=0;c<b.length;c++)this.cases[b[c]]=new Tr8n.LanguageCase(Tr8n.Utils.extend(a.cases[b[c]],{language:this}))},Tr8n.Language.prototype={getContextByKeyword:function(a){return this.contexts[a]},getContextByTokenName:function(a){for(var b=Tr8n.Utils.keys(this.contexts||{}),c=0;c<b.length;c++)if(this.contexts[b[c]].isAppliedToToken(a))return this.contexts[b[c]];return null},getLanguageCaseByKeyword:function(a){return this.cases[a]},isDefault:function(){return this.locale==Tr8n.config.default_locale},translate:function(a,b,c,d){var e=new Tr8n.TranslationKey({label:a,description:b,language:this.application?this.application.getLanguage():null});return e.translate(this,c,d)}},Tr8n.LanguageCase=function(a){Tr8n.Utils.extend(this,a),this.rules=[],a.rules=a.rules||[];for(var b=0;b<a.rules.length;b++)this.rules.push(new Tr8n.LanguageCaseRule(Tr8n.Utils.extend(a.rules[b],{language_case:this})))},Tr8n.LanguageCase.prototype={findMatchingRule:function(a,b){for(var c=0;c<this.rules.length;c++){var d=this.rules[c];if(d.evaluate(a,b))return d}return null},apply:function(a,b,c){var d=Tr8n.Utils.unique(a.match(/<\/?[^>]*>/g)||[]),e=a.replace(/<\/?[^>]*>/g,""),f=[e];"phrase"!=this.application&&(f=Tr8n.Utils.unique(e.split(/[\s\/]/)||[]));for(var g=0;g<d.length;g++)a=a.replace(d[g],"{$h"+g+"}");for(g=0;g<f.length;g++)a=a.replace(f[g],"{$w"+g+"}");var h=[];for(g=0;g<f.length;g++){var i=f[g],j=this.findMatchingRule(i,b),k=j?j.apply(i):i;h.push(this.decorate(i,k,j,c))}for(g=0;g<f.length;g++)a=a.replace("{$w"+g+"}",h[g]);for(var g=0;g<d.length;g++)a=a.replace("{$h"+g+"}",d[g]);return a},getConfig:function(){return Tr8n.config},decorate:function(a,b,c,d){return d&&d.skip_decoration||null==this.language||this.language.isDefault()||null==this.getConfig().current_translator||!this.getConfig().current_translator.isInlineModeEnabled()?b:"<tr8n:tr class='tr8n_language_case' data-original='"+a.replaceAll("'","'")+"'>"+b+"</tr8n:tr>"}},Tr8n.LanguageCaseRule=function(a){Tr8n.Utils.extend(this,a)},Tr8n.LanguageCaseRule.prototype={getConditionsExpression:function(){return this.conditions_expression||(this.conditions_expression=new Tr8n.RulesEngine.Parser(this.conditions).parse()),this.conditions_expression},getOperationsExpression:function(){return this.operations_expression||(this.operations_expression=new Tr8n.RulesEngine.Parser(this.operations).parse()),this.operations_expression},getGenderVariables:function(a){if(-1==this.conditions.indexOf("@gender"))return{};if(null==a)return{gender:"unknown"};var b=this.language_case.language.getContextByKeyword("gender");return null==b?{gender:"unknown"}:b.getVars(a)},evaluate:function(a,b){if(null==this.conditions)return!1;var c=new Tr8n.RulesEngine.Evaluator;return c.setVars(Tr8n.Utils.extend({"@value":a},this.getGenderVariables(b))),c.evaluate(this.getConditionsExpression())},apply:function(a){if(null==this.operations)return a;var b=new Tr8n.RulesEngine.Evaluator;return b.setVars({"@value":a}),b.evaluate(this.getOperationsExpression())}},Tr8n.LanguageContext=function(a){Tr8n.Utils.extend(this,a),this.rules={};for(var b=Tr8n.Utils.keys(a.rules||{}),c=0;c<b.length;c++)this.rules[b[c]]=new Tr8n.LanguageContextRule(Tr8n.Utils.extend(a.rules[b[c]],{language_context:this}))},Tr8n.LanguageContext.prototype={isAppliedToToken:function(a){var b=new RegExp(this.token_expression.substring(1,this.token_expression.length-2));return null!=a.match(b)},getFallbackRule:function(){if(!this.fallback_rule)for(var a=Tr8n.Utils.keys(this.rules),b=0;b<a.length;b++){var c=a[b];this.rules[c].isFallback()&&(this.fallback_rule=this.rules[c])}return this.fallback_rule},getConfig:function(){return Tr8n.config.getContextRules(this.keyword)},getVars:function(a){for(var b={},c=this.getConfig(),d=0;d<this.variables.length;d++){var e=this.variables[d];if(c.variables&&c.variables[e]){var f=c.variables[e];"string"==typeof f?(a.object&&(a=a.object),b[e]=a[f]):b[e]="function"==typeof f?f(a):a}else b[e]=a}return b},findMatchingRule:function(a){for(var b=this.getVars(a),c=Tr8n.Utils.keys(this.rules),d=0;d<c.length;d++){var e=this.rules[c[d]];if(!e.isFallback()&&e.evaluate(b))return e}return this.getFallbackRule()}},Tr8n.LanguageContextRule=function(a){Tr8n.Utils.extend(this,a)},Tr8n.LanguageContextRule.prototype={isFallback:function(){return"other"==this.keyword},getConditionsExpression:function(){return this.conditions_expression||(this.conditions_expression=new Tr8n.RulesEngine.Parser(this.conditions).parse()),this.conditions_expression},evaluate:function(a){if(this.isFallback())return!0;var b=new Tr8n.RulesEngine.Evaluator;return b.setVars(a||{}),b.evaluate(this.getConditionsExpression())}};var fs=require("fs"),path=require("path"),async=require("async"),cookies=require("cookies"),tr8n_scripts=require(__dirname+"/tr8n.helpers.js");Tr8n.config=new Tr8n.Configuration,exports.configure=function(a){a(Tr8n.config)},exports.init=function(a,b,c){return c=c||{},Tr8n.Utils.extend(Tr8n.config,c),function(d,e,f){var g=Tr8n.Utils.decodeAndVerifyParams(new cookies(d,e).get("tr8n_"+a),b);console.log("Got Cookie:"),console.log(g);var h=g.locale,i=g.translator?new Tr8n.Translator(g.translator):null,j=new Tr8n.Application({key:a,secret:b,host:c.host||"http://localhost:3001"});d.tr8n_block_options=[],e.locals.tr=function(a,b,c,e){return"string"!=typeof b&&(c=b,b=""),c=c||{},e=e||{},c.viewing_user=d.user,e.current_translator=i,e.block_options=d.tr8n_block_options,j.getLanguage(h)?j.getLanguage(h).translate(a,b,c,e):j.getLanguage(j.default_locale).translate(a,b,c,e)},e.locals.tr8n_scripts=function(){return tr8n_scripts.header(j,{current_language:j.getLanguage(h)||j.getLanguage(j.default_locale)})},e.locals.tr8n_block_with_options=function(a,b){d.tr8n_block_options.unshift(a),b(),d.tr8n_block_options.pop()};var k=function(){e.removeListener("finish",k),e.removeListener("close",k),j.submitMissingTranslationKeys()};e.on("finish",k),e.on("close",k),j.init({locales:[j.default_locale,h],sources:[]},function(){e.locals.tr8n_application=j,e.locals.tr8n_default_language=j.getLanguage(j.default_locale),e.locals.tr8n_current_language=j.getLanguage(h),f()})}};