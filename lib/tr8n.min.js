/*! tr8n 10-07-2014 */
var Tr8n={Tokenizers:{Tokens:{}},Utils:{},RulesEngine:{},Decorators:{}};Tr8n.Utils.hashValue=function(a,b,c){c=c||null;for(var d=b.split("."),e=0;e<d.length;e++){var f=d[e];if("undefined"==typeof a[f])return c;a=a[f]}return a},Tr8n.Utils.stripTags=function(a,b){b=(((b||"")+"").toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var c=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,d=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;return a.replace(d,"").replace(c,function(a,c){return b.indexOf("<"+c.toLowerCase()+">")>-1?a:""})},Tr8n.Utils.splitSentences=function(a){var b=/[^.!?\s][^.!?]*(?:[.!?](?![\'"]?\s|$)[^.!?]*)*[.!?]?[\'"]?(?=\s|$)/g;return Tr8n.Utils.stripTags(a).match(b)},Tr8n.Utils.unique=function(a){return a.reverse().filter(function(a,b,c){return-1===c.indexOf(a,b+1)}).reverse()},Tr8n.Utils.extend=function(a,b){for(var c in b)a[c]=b[c];return a},Tr8n.Configuration=function(){this.initDefaultTokens(),this.initTranslatorOptions(),this.currentLanguage=new Tr8n.Language},Tr8n.Configuration.prototype.initDefaultTokens=function(){this.defaultTokens={html:{data:{ndash:"&ndash;",mdash:"&mdash;",iexcl:"&iexcl;",iquest:"&iquest;",quot:"&quot;",ldquo:"&ldquo;",rdquo:"&rdquo;",lsquo:"&lsquo;",rsquo:"&rsquo;",laquo:"&laquo;",raquo:"&raquo;",nbsp:"&nbsp;",lsaquo:"&lsaquo;",rsaquo:"&rsaquo;",br:"<br/>",lbrace:"{",rbrace:"}",trade:"&trade;"},decoration:{strong:"<strong>{$0}</strong>",bold:"<strong>{$0}</strong>",b:"<strong>{$0}</strong>",em:"<em>{$0}</em>",italic:"<i>{$0}</i>",i:"<i>{$0}</i>",link:"<a href='{$href}'>{$0}</a>",br:"<br>{$0}",strike:"<strike>{$0}</strike>",div:"<div id='{$id}' class='{$class}' style='{$style}'>{$0}</div>",span:"<span id='{$id}' class='{$class}' style='{$style}'>{$0}</span>",h1:"<h1>{$0}</h1>",h2:"<h2>{$0}</h2>",h3:"<h3>{$0}</h3>"}},text:{data:{ndash:"–",mdash:"-",iexcl:"¡",iquest:"¿",quot:'"',ldquo:"“",rdquo:"”",lsquo:"‘",rsquo:"’",laquo:"«",raquo:"»",nbsp:" ",lsaquo:"‹",rsaquo:"›",br:"\n",lbrace:"{",rbrace:"}",trade:"™"},decoration:{strong:"{$0}",bold:"{$0}",b:"{$0}",em:"{$0}",italic:"{$0}",i:"{$0}",link:"{$0}{$1}",br:"\n{$0}",strike:"{$0}",div:"{$0}",span:"{$0}",h1:"{$0}",h2:"{$0}",h3:"{$0}"}}}},Tr8n.Configuration.prototype.defaultToken=function(a,b,c){return b=b||"data",c=c||"html","undefined"==typeof this.defaultTokens[c][b][a]?null:new String(this.defaultTokens[c][b][a])},Tr8n.Configuration.prototype.setDefaultToken=function(a,b,c,d){c=c||"data",d=d||"html",this.defaultTokens[d]=this.defaultTokens[d]||{},this.defaultTokens[d][c]=this.defaultTokens[d][c]||{},this.defaultTokens[d][c][a]=b},Tr8n.Configuration.prototype.initTranslatorOptions=function(){this.translatorOptions={debug:!0,debug_format_html:"<span style='font-size:20px;color:red;'>{</span> {$0} <span style='font-size:20px;color:red;'>}</span>",debug_format:"{{{{$0}}}}",split_sentences:!1,nodes:{ignored:[],scripts:["style","script"],inline:["a","span","i","b","img","strong","s","em","u","sub","sup"],"short":["i","b"],splitters:["br","hr"]},attributes:{labels:["title","alt"]},name_mapping:{b:"bold",i:"italic",a:"link",img:"picture"},data_tokens:{special:!1,numeric:!1,numeric_name:"num"}}},Tr8n.RulesEngine.Evaluator=function(a){return this.vars={},this.ctx=a||{label:function(a,b){return this.vars[a]=this.ctx[a]=b,b}.bind(this),quote:function(a){return a}.bind(this),car:function(a){return a[1]}.bind(this),cdr:function(a){return a.shift(),a}.bind(this),cons:function(a,b){return b.unshift(a),b}.bind(this),eq:function(a,b){return a==b}.bind(this),atom:function(a){return!(typeof a in{object:1,array:1,"function":1})}.bind(this),cond:function(a,b,c){return this.evaluate(this.evaluate(a)?b:c)}.bind(this),set:function(a,b){return this.vars[a]=this.ctx[a]=b,b}.bind(this),"=":function(a){return a[0]==a[1]}.bind(this),"!=":function(a){return a[0]!=a[1]}.bind(this),"<":function(a){return a[0]<a[1]}.bind(this),">":function(a){return a[0]>a[1]}.bind(this),"+":function(a){return a[0]+a[1]}.bind(this),"-":function(a){return a[0]-a[1]}.bind(this),"*":function(a){return a[0]*a[1]}.bind(this),"/":function(a){return a[0]/a[1]}.bind(this),"!":function(a){return""+a=="true"?!1:!0}.bind(this),not:function(a){return this.ctx["!"](a)}.bind(this),"&&":function(a){for(var b=0;b<a.length;++b)if(!this.evaluate(a[b]))return!1;return!0}.bind(this),and:function(a){return this.ctx["&&"](a)}.bind(this),"||":function(a){for(var b=0;b<a.length;++b)if(this.evaluate(a[b]))return!0;return!1}.bind(this),or:function(a){return this.ctx["||"](a)}.bind(this)},this},Tr8n.RulesEngine.Evaluator.prototype={apply:function(a,b){return"function"==typeof this.ctx[a]?this.ctx[a](b):this.ctx[a]},evaluate:function(a){if(this.ctx.atom(a))return a in this.ctx?this.ctx[a]:a;var b=a[0],c=a.slice(1);return-1==["quote","cdr","cond","if","&&","||","and","or","true","false","let","count","all","any"].indexOf(b)&&(c=c.map(function(a){return this.evaluate(a)}.bind(this))),this.apply(b,c)}},Tr8n.RulesEngine.Parser=function(a){this.tokenize(a)},Tr8n.RulesEngine.Parser.prototype={tokenize:function(a){this.tokens=a.match(/[()]|\w+|@\w+|[\+\-\!\|\=>&<\*\/%]+|\".*?\"|'.*?'/g)},parse:function(){return(token=this.tokens.shift())?"("==token?this.parseList():token.match(/^['"].*/)?token.slice(1,-1):token.match(/\d+/)?parseInt(token):String(token):void 0},parseList:function(){for(var a=[];this.tokens.length>0&&")"!=this.tokens[0];)a.push(this.parse());return this.tokens.shift(),a}},Tr8n.Tokenizers.DataTokenizer=function(a,b,c){this.label=a,this.context=b||{},this.options=c||{},this.tokens=[]},Tr8n.Tokenizers.DataTokenizer.prototype.supportedTokens=function(){return[[/(\{[^_:][\w]*(:[\w]+)*(::[\w]+)*\})/,Tr8n.Tokens.Data],[/(\{[^_:.][\w]*(\.[\w]+)(:[\w]+)*(::[\w]+)*\})/,Tr8n.Tokens.Method],[/(\{[^_:|][\w]*(:[\w]+)*(::[\w]+)*\s*\|\|?[^{^}]+\})/,Tr8n.Tokens.Piped]]},Tr8n.Tokenizers.DataTokenizer.prototype.tokenize=function(){var a=this;a.tokens=[],a.supportedTokens().forEach(function(b){var c=a.label.match(tokensInfo[0]);c&&Tr8n.Utils.unique(c).forEach(function(c){a.tokens.push(new b[1](a.label,c))})})},Tr8n.Tokenizers.DataTokenizer.prototype.isTokenAllowed=function(a){return null==this.options.allowed_tokens?!0:-1!=this.options.allowed_tokens.indexOf(a.name)},Tr8n.Tokenizers.DataTokenizer.prototype.substitute=function(a,b){var c=this.label,d=this;return d.tokens.forEach(function(e){d.isTokenAllowed(e)&&(c=e.substitute(c,d.context,a,b))}),c};var RESERVED_TOKEN="tr8n",RE_SHORT_TOKEN_START="\\[[\\w]*:",RE_SHORT_TOKEN_END="\\]",RE_LONG_TOKEN_START="\\[[\\w]*\\]",RE_LONG_TOKEN_END="\\[\\/[\\w]*\\]",RE_TEXT="[^\\[\\]]+",TOKEN_TYPE_SHORT="short",TOKEN_TYPE_LONG="long",PLACEHOLDER="{$0}";Tr8n.Tokenizers.DecorationTokenizer=function(a,b,c){this.label="["+RESERVED_TOKEN+"]"+a+"[/"+RESERVED_TOKEN+"]",this.context=b||{},this.opts=c||{},this.fragments=[],this.tokens=[],this.tokenize()},Tr8n.Tokenizers.DecorationTokenizer.prototype.tokenize=function(){var a=new RegExp([RE_SHORT_TOKEN_START,RE_SHORT_TOKEN_END,RE_LONG_TOKEN_START,RE_LONG_TOKEN_END,RE_TEXT].join("|"),"g");return this.fragments=this.label.match(a),this.fragments},Tr8n.Tokenizers.DecorationTokenizer.prototype.peek=function(){return 0==this.fragments.length?null:this.fragments[0]},Tr8n.Tokenizers.DecorationTokenizer.prototype.nextFragment=function(){return 0==this.fragments.length?null:this.fragments.shift()},Tr8n.Tokenizers.DecorationTokenizer.prototype.parse=function(){var a=this.nextFragment();return a.match(new RegExp(RE_SHORT_TOKEN_START))?this.parseTree(a.replace(/[\[:]/g,""),TOKEN_TYPE_SHORT):a.match(new RegExp(RE_LONG_TOKEN_START))?this.parseTree(a.replace(/[\[\]]/g,""),TOKEN_TYPE_LONG):a},Tr8n.Tokenizers.DecorationTokenizer.prototype.parseTree=function(a,b){var c=[a];if(-1==this.tokens.indexOf(a)&&a!=RESERVED_TOKEN&&this.tokens.push(a),b==TOKEN_TYPE_SHORT)for(var d=!0;null!=this.peek()&&!this.peek().match(new RegExp(RE_SHORT_TOKEN_END));){var e=this.parse();d&&"string"==typeof e&&(e=e.replace(/^\s+/,""),d=!1),c.push(e)}else if(b==TOKEN_TYPE_LONG)for(;null!=this.peek()&&!this.peek().match(new RegExp(RE_LONG_TOKEN_END));)c.push(this.parse());return this.nextFragment(),c},Tr8n.Tokenizers.DecorationTokenizer.prototype.isTokenAllowed=function(a){return null==this.opts.allowed_tokens||-1!=this.opts.allowed_tokens.indexOf(a)},Tr8n.Tokenizers.DecorationTokenizer.prototype.defaultDecoration=function(a,b){var c=Tr8n.config.defaultToken(a,"decoration");if(null==c)return b;var d=this.context[a];return c=c.replace(PLACEHOLDER,b),d instanceof Object&&Object.keys(d).forEach(function(a){c=c.replace("{$"+a+"}",d[a])}),c},Tr8n.Tokenizers.DecorationTokenizer.prototype.apply=function(a,b){if(a==RESERVED_TOKEN)return b;if(!this.isTokenAllowed(a))return b;var c=this.context[a];return null!=c?"string"==typeof c?c.replace(PLACEHOLDER,b):"function"==typeof c?c(b):"object"==typeof c?this.defaultDecoration(a,b):b:this.defaultDecoration(a,b)},Tr8n.Tokenizers.DecorationTokenizer.prototype.evaluate=function(a){if(!(a instanceof Array))return a;var b=a[0];a.shift();var c=this,d=[];return a.forEach(function(a){d.push(c.evaluate(a))}),this.apply(b,d.join(""))},Tr8n.Tokenizers.DecorationTokenizer.prototype.substitute=function(){return this.evaluate(this.parse())};var HTML_SPECIAL_CHAR_REGEX="/(&[^;]*;)/",INDEPENDENT_NUMBER_REGEX="/^(\\d+)$|^(\\d+[,;\\s])|(\\s\\d+)$|(\\s\\d+[,;\\s])/",VERBOSE_DATE_REGEX="/(((Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)|(January|February|March|April|May|June|July|August|September|October|November|December))\\s\\d+(,\\s\\d+)*(,*\\sat\\s\\d+:\\d+(\\sUTC))*)/";Tr8n.Tokenizers.DomTokenizer=function(a,b,c){this.doc=a,this.context=b||{},this.tokens=[],this.options=c||{}},Tr8n.Tokenizers.DomTokenizer.prototype.translate=function(){return this.translateTree(this.doc)},Tr8n.Tokenizers.DomTokenizer.prototype.translateTree=function(a){if(this.isNonTranslatableNode(a))return 1==a.childNodes.length?a.childNodes[0].nodeValue:"";if(3==a.nodeType)return this.translateTml(a.nodeValue);for(var b="",c="",d=0;d<a.childNodes.length;d++){var e=a.childNodes[d];if(3==e.nodeType)c+=e.nodeValue;else if(this.isInlineNode(e)&&this.hasInlineOrTextSiblings(e)&&!this.isBetweenSeparators(e))c+=this.generateTmlTags(e);else if(this.isSeparatorNode(e))""!=c&&(b+=this.translateTml(c)),b+=this.generateHtmlToken(e),c="";else{""!=c&&(b+=this.translateTml(c));var f=this.translateTree(e);b+=this.isIgnoredNode(e)?f:this.generateHtmlToken(e,f),c=""}}return""!=c&&(b+=this.translateTml(c)),b},Tr8n.Tokenizers.DomTokenizer.prototype.isNonTranslatableNode=function(a){return 1==a.nodeType&&-1!=this.getOption("nodes.scripts").indexOf(a.nodeName.toLowerCase())?!0:1==a.nodeType&&0==a.childNodes.length&&""==a.nodeValue?!0:!1},Tr8n.Tokenizers.DomTokenizer.prototype.translateTml=function(a){if(this.isEmptyString(a))return a;if(this.getOption("split_sentences")){sentences=Tr8n.Utils.splitSentences(a),translation=a;var b=this;return sentences.forEach(function(a){var c=b.getOption("debug")?b.debugTranslation(a):Tr8n.config.currentLanguage.translate(a,null,b.tokens,b.options);translation=translation.replace(a,c)}),this.resetContext(),translation}return translation=this.getOption("debug")?this.debugTranslation(a):Tr8n.config.currentLanguage.translate(a,null,this.tokens,this.options),this.resetContext(),translation},Tr8n.Tokenizers.DomTokenizer.prototype.hasChildNodes=function(a){return a.childNodes?a.childNodes.length>0:!1},Tr8n.Tokenizers.DomTokenizer.prototype.isBetweenSeparators=function(a){return this.isSeparatorNode(a.previousSibling)&&!this.isValidTextNode(a.nextSibling)?!0:this.isSeparatorNode(a.nextSibling)&&!this.isValidTextNode(a.previousSibling)?!0:!1},Tr8n.Tokenizers.DomTokenizer.prototype.generateTmlTags=function(a){for(var b="",c=this,d=0;d<a.childNodes.length;d++){var e=a.childNodes[d];b+=3==e.nodeType?e.nodeValue:c.generateTmlTags(e)}var f=c.generateHtmlToken(a),g=this.contextualize(this.adjustName(a),f),h=this.sanitizeValue(b);return this.isSelfClosingNode(a)?"{"+g+"}":this.isShortToken(g,h)?"["+g+": "+h+"]":"["+g+"]"+h+"[/"+g+"]"},Tr8n.Tokenizers.DomTokenizer.prototype.getOption=function(a){return this.options[a]?this.options[a]:Tr8n.Utils.hashValue(Tr8n.config.translatorOptions,a)},Tr8n.Tokenizers.DomTokenizer.prototype.debugTranslation=function(a){return this.getOption("debug_format").replace("{$0}",a)},Tr8n.Tokenizers.DomTokenizer.prototype.isEmptyString=function(a){return a=a.replace(/[\s\n\r\t\0\x0b\xa0\xc2]/g,""),""==a},Tr8n.Tokenizers.DomTokenizer.prototype.resetContext=function(){this.tokens=[].concat(this.context)},Tr8n.Tokenizers.DomTokenizer.prototype.isShortToken=function(a,b){return-1!=this.getOption("nodes.short").indexOf(a.toLowerCase())||b.length<20},Tr8n.Tokenizers.DomTokenizer.prototype.isOnlyChild=function(a){return null==a.parentNode?!1:1==a.parentNode.childNodes.length},Tr8n.Tokenizers.DomTokenizer.prototype.hasInlineOrTextSiblings=function(a){if(null==a.parentNode)return!1;for(var b=0;b<a.parentNode.childNodes.length;b++){var c=a.parentNode.childNodes[b];if(c!=a&&(this.isInlineNode(c)||this.isValidTextNode(c)))return!0}return!1},Tr8n.Tokenizers.DomTokenizer.prototype.isInlineNode=function(a){return 1==a.nodeType&&-1!=this.getOption("nodes.inline").indexOf(a.tagName.toLowerCase())&&!this.isOnlyChild(a)},Tr8n.Tokenizers.DomTokenizer.prototype.isContainerNode=function(a){return 1==a.nodeType&&!this.isInlineNode(a)},Tr8n.Tokenizers.DomTokenizer.prototype.isSelfClosingNode=function(a){return null==a.firstChild},Tr8n.Tokenizers.DomTokenizer.prototype.isIgnoredNode=function(a){return 1!=a.nodeType?!0:-1!=this.getOption("nodes.ignored").indexOf(a.tagName.toLowerCase())},Tr8n.Tokenizers.DomTokenizer.prototype.isValidTextNode=function(a){return null==a?!1:3==a.nodeType&&!this.isEmptyString(a.nodeValue)},Tr8n.Tokenizers.DomTokenizer.prototype.isSeparatorNode=function(a){return null==a?!1:1==a.nodeType&&-1!=this.getOption("nodes.splitters").indexOf(a.tagName.toLowerCase())},Tr8n.Tokenizers.DomTokenizer.prototype.sanitizeValue=function(a){return a.replace(/^\s+/,"")},Tr8n.Tokenizers.DomTokenizer.prototype.replaceSpecialCharacters=function(a){if(!this.getOption("data_tokens.special"))return a;var b=a.match(HTML_SPECIAL_CHAR_REGEX),c=this;return b.forEach(function(b){token=b.substring(1,b.length-2),c.context[token]=b,a=a.replace(b,"{"+token+"}")}),a},Tr8n.Tokenizers.DomTokenizer.prototype.generateDataTokens=function(a){if(!this.getOption("data_tokens.numeric"))return a;var b=a.match(INDEPENDENT_NUMBER_REGEX),c=this.getOption("data_tokens.numeric_name"),d=this;return b.forEach(function(b){value=b.replace(/[,;]\s/,""),token=d.contextualize(c,value),a=a.replace(b,b.replace(value,"{"+token+"}"))}),a},Tr8n.Tokenizers.DomTokenizer.prototype.generateHtmlToken=function(a,b){var c=a.tagName.toLowerCase(),d=a.attributes,e={};if(b=null==b?"{0}":b,0==d.length)return this.isSelfClosingNode(a)?"<"+c+"/>":"<"+c+">"+b+"</"+c+">";for(var f=0;f<d.length;f++)e[d[f].name]=d[f].value;var g=Object.keys(e);g.sort();var h=[];return g.forEach(function(a){var b=-1!=e[a].indexOf("'")?'"':"'";h.push(a+"="+b+e[a]+b)}),h=h.join(" "),this.isSelfClosingNode(a)?"<"+c+" "+h+"/>":"<"+c+" "+h+">"+b+"</"+c+">"},Tr8n.Tokenizers.DomTokenizer.prototype.adjustName=function(a){var b=a.tagName.toLowerCase(),c=this.getOption("name_mapping");return b=null!=c[b]?c[b]:b},Tr8n.Tokenizers.DomTokenizer.prototype.contextualize=function(a,b){if(this.tokens[a]&&this.tokens[a]!=b){var c=0,d=a.match(/\d+$/);return d&&d.length>0&&(c=parseInt(d[d.length-1]),a=a.replace(""+c,"")),a+=c+1,this.contextualize(a,b)}return this.tokens[a]=b,a},Tr8n.Tokenizers.DomTokenizer.prototype.debug=function(a){this.doc=a,this.debugTree(a,0)},Tr8n.Tokenizers.DomTokenizer.prototype.debugTree=function(a,b){var c=new Array(b+1).join("=");if(console.log(c+"=> "+typeof a+": "+this.nodeInfo(a)),a.childNodes)for(var d=this,e=0;e<a.childNodes.length;e++){var f=a.childNodes[e];d.debugTree(f,b+1)}},Tr8n.Tokenizers.DomTokenizer.prototype.nodeInfo=function(a){var b=[];return b.push(a.nodeType),1==a.nodeType&&b.push(a.tagName),this.isInlineNode(a)&&(b.push("inline"),b.push(this.hasInlineOrTextSiblings(a)?"sentence":"only translatable")),this.isSelfClosingNode(a)&&b.push("self closing"),this.isOnlyChild(a)&&b.push("only child"),3==a.nodeType?"["+b.join(", ")+']: "'+a.nodeValue+'"':"["+b.join(", ")+"]"},Tr8n.Language=function(a){this.attrs=a},Tr8n.Language.prototype.translate=function(a){return a};var program=require("commander");program.version("0.1.1").option("-l, --label","Label to be translated").option("-d, --description","Description of the label").option("-t, --tokens","Tokens to be substituted").option("-o, --options","Options").parse(process.argv),Tr8n.config=new Tr8n.Configuration,exports.RulesEngine=Tr8n.RulesEngine,exports.Tokenizers=Tr8n.Tokenizers,exports.Decorators=Tr8n.Decorators,exports.Utils=Tr8n.Utils,exports.configure=Tr8n.configure;